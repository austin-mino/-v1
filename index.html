<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>💣 지뢰찾기</title>
<style>
  /* ─── 색상 토큰 ─── */
  :root{
    --bg:#1a1a1a; --cell:#333; --text:#f0f0f0;
    --rev:#555;   --mine:#e74c3c; --flag:#2ecc71;
    --cell-size:40px;
  }
  body.light{
    --bg:#f0f0f0; --cell:#ddd; --text:#1a1a1a;
    --rev:#eee;   --mine:#e74c3c; --flag:#27ae60;
  }
  /* 모바일-가변 셀 크기 */
  @media(max-width:600px){:root{--cell-size:32px}}
  @media(max-width:420px){:root{--cell-size:26px}}
  @media(max-width:360px){:root{--cell-size:22px}}

  /* ─── 기본 스타일 ─── */
  body{
    margin:0;padding:20px;text-align:center;
    background:var(--bg);color:var(--text);
    font-family:'Segoe UI',sans-serif;
    transition:background .3s,color .3s;
  }
  h1{color:#00bcd4;margin-top:0}
  #controls{margin-bottom:10px}
  #board{
    display:grid;gap:2px;justify-content:center;margin-top:16px;
    touch-action:none; /* iOS 더블탭 확대 방지 */
  }
  .cell{
    width:var(--cell-size);height:var(--cell-size);
    background:var(--cell);border-radius:6px;
    display:flex;align-items:center;justify-content:center;
    color:var(--text);font-size:calc(var(--cell-size)*0.5);
    user-select:none;transition:background .15s;
  }
  .revealed{background:var(--rev)}
  .mine{background:var(--mine)}
  .flagged{background:var(--flag)}
  #themeToggle{
    position:fixed;top:16px;right:16px;
    background:#00bcd4;border:none;border-radius:6px;
    color:#fff;padding:8px 12px;cursor:pointer
  }
  #winMessage{display:none;font-size:1.5rem;color:#4caf50;margin-top:10px}
</style>
</head>
<body>
<button id="themeToggle">🌙 테마</button>
<h1>💣 지뢰찾기</h1>

<div id="controls">
  난이도:
  <select id="difficulty">
    <option value="easy">쉬움 (8×8, 10)</option>
    <option value="medium" selected>보통 (10×10, 15)</option>
    <option value="hard">어려움 (12×12, 25)</option>
  </select>
  <button id="startBtn">게임 시작</button>
  <button id="resetBtn">🔄 재시작</button>
  <p>⏱ <span id="timer">0</span>초 | 🏴 <span id="flagsLeft">0</span></p>
  <div id="winMessage">🎉 성공했습니다! 축하합니다!</div>
</div>

<div id="board"></div>

<script>
/* ─── DOM ─── */
const board       = document.getElementById('board');
const timerDOM    = document.getElementById('timer');
const flagsDOM    = document.getElementById('flagsLeft');
const diffSelect  = document.getElementById('difficulty');
const winMessage  = document.getElementById('winMessage');
const startBtn    = document.getElementById('startBtn');
const resetBtn    = document.getElementById('resetBtn');
/* ─── 게임 상태 ─── */
let size=10, mines=15, cells=[], flagsLeft=0;
let firstClick=true, revealed=0, timer=0, tHandle;

/* ─── 모바일 long-press 플래그용 ─── */
const LONG=500; //ms

/* ─── 헬퍼 ─── */
const idx=(x,y)=>y*size+x;

/* ─── 초기화 ─── */
startBtn.onclick = generate;
resetBtn.onclick = resetGame;
document.getElementById('themeToggle').onclick= ()=>{
  document.body.classList.toggle('light');
  event.target.textContent = document.body.classList.contains('light')?'🌞 테마':'🌙 테마';
};
generate();

/* ─── 보드 생성 ─── */
function generate(){
  clearInterval(tHandle); timer=0; timerDOM.textContent=0;
  firstClick=true; revealed=0; winMessage.style.display='none';
  const diff=diffSelect.value;
  if(diff==='easy'){size=8; mines=10}
  else if(diff==='medium'){size=10; mines=15}
  else {size=12; mines=25}
  board.style.gridTemplateColumns=`repeat(${size},var(--cell-size))`;
  board.style.gridTemplateRows  =`repeat(${size},var(--cell-size))`;
  board.innerHTML=''; cells=[];
  flagsLeft=mines; flagsDOM.textContent=flagsLeft;

  for(let i=0;i<size*size;i++){
    const d=document.createElement('div'); d.className='cell';
    d.dataset.idx=i; board.appendChild(d); cells.push(d);

    /* click / long-press 분리  */
    let pressTimer, moved=false;
    d.addEventListener('touchstart',e=>{
      moved=false;
      pressTimer=setTimeout(()=>{toggleFlag(i); moved=true;}, LONG);
    });
    d.addEventListener('touchmove',()=>{clearTimeout(pressTimer); moved=true;});
    d.addEventListener('touchend',e=>{
      if(!moved){ clearTimeout(pressTimer); handleClick(i); }
    });
    /* 데스크톱 */
    d.addEventListener('click', ()=>handleClick(i));
    d.addEventListener('contextmenu',e=>{e.preventDefault(); toggleFlag(i);});
  }
}
function resetGame(){ generate(); }

/* ─── 타이머 ─── */
function startTimer(){
  tHandle=setInterval(()=>{timer++; timerDOM.textContent=timer;},1000);
}

/* ─── 지뢰 배치 (첫 클릭 안전) ─── */
function plantMines(excl){
  const set=new Set();
  while(set.size<mines){
    const r=Math.floor(Math.random()*size*size);
    if(r!==excl) set.add(r);
  }
  set.forEach(i=>cells[i].dataset.mine='1');
}

/* ─── 인접 지뢰 수 ─── */
function adj(x,y){
  let c=0;
  for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){
    if(dx||dy){
      const nx=x+dx, ny=y+dy;
      if(nx>=0&&ny>=0&&nx<size&&ny<size)
        if(cells[idx(nx,ny)].dataset.mine==='1') c++;
    }
  }
  return c;
}

/* ─── 클릭 / 열기 ─── */
function handleClick(i){
  const d=cells[i];
  if(d.classList.contains('revealed')||d.classList.contains('flagged'))return;

  if(firstClick){
    plantMines(i); startTimer(); firstClick=false;
  }
  reveal(i);
}

function reveal(i){
  const d=cells[i];
  if(!d||d.classList.contains('revealed')||d.classList.contains('flagged'))return;

  d.classList.add('revealed'); revealed++;

  if(d.dataset.mine==='1'){
    d.classList.add('mine'); d.textContent='💣';
    revealMines(); clearInterval(tHandle); alert('💥 지뢰! 게임 오버');
    return;
  }
  const x=i%size, y=Math.floor(i/size), n=adj(x,y);
  if(n){ d.textContent=n; }
  else{
    for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){
      const nx=x+dx, ny=y+dy;
      if(nx>=0&&ny>=0&&nx<size&&ny<size) reveal(idx(nx,ny));
    }
  }
  if(revealed===size*size-mines){
    winMessage.style.display='block'; clearInterval(tHandle);
  }
}

/* ─── 깃발 ─── */
function toggleFlag(i){
  const d=cells[i];
  if(d.classList.contains('revealed'))return;
  if(d.classList.contains('flagged')){
    d.classList.remove('flagged'); d.textContent=''; flagsLeft++;
  }else if(flagsLeft){
    d.classList.add('flagged'); d.textContent='🚩'; flagsLeft--;
  }
  flagsDOM.textContent=flagsLeft;
}

/* ─── 전체 지뢰 표시 ─── */
function revealMines(){
  cells.forEach(c=>{ if(c.dataset.mine==='1'){c.classList.add('revealed','mine'); c.textContent='💣';} });
}
</script>
</body>
</html>
